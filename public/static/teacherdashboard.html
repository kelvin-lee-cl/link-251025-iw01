<!DOCTYPE html>

<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>AI workshop - AKA</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" type="text/css" href="styles.css">
    <style>
        /* Custom navbar styling */
        .navbar {
            background-color: #FFFFFF !important;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            height: 80px;
        }

        .navbar-light .navbar-nav .nav-link {
            color: #333333;
        }

        .navbar-light .navbar-nav .nav-link:hover {
            color: #D87D3A;
        }


        li.active {
            font-weight: bold;
        }

        @media (max-width: 900px) {
            .section-box {
                padding: 1rem;
            }

            .flu_logo {
                position: absolute;
                left: 10px;
                top: 0px;
            }

            .school_logo {
                display: none;
                position: absolute;
                left: 150px;
                top: 12px;
            }
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light px-5 fixed-top">
        <div>
            <a class="navbar-brand flu_logo" href="https://future-leaders-union.odoo.com/zh_TW" target="_blank">
                <img class="mx-4" src="./images/FLU_logo2.png" style="margin-top:12px;" width="100"
                    class="d-inline-block align-top" alt="">
            </a>
            <a class="navbar-brand school_logo" href="https://mcsps.edu.hk/" target="_blank">
                <img class="d-none" src="https://mcsps.edu.hk/wp-content/uploads/2024/09/BADGEHI.png" height="90"
                    class="d-inline-block align-top" style="padding:5px;" alt="" target="_blank"></a>
        </div>

        <span id="userIdDisplay" class="text-black me-3">User: <span id="userId"></span></span>

        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="justify-content-end collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav ml-auto mx-2">
                <li class="nav-item">
                    <a class="nav-link" href="index.html">Home</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="classppt.html">Lessons</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="../img-gen/img_gen.html">AI Art Studio</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="text-gen.html">Story Generator</a>
                </li>
                <li class="nav-item active" id="teacherArea">
                    <a class="nav-link" href="teacherdashboard.html">Gallery</a>
                </li>


                <button onclick="logout()" class="btn btn-secondary" id="logoutBtn">Logout</button>
            </ul>
        </div>
    </nav>

    <div class="container" style="margin-top: 90px;">
        <!-- Add this modal HTML -->
        <div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="imageModalLabel">Image Preview</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body position-relative">
                        <button class="btn btn-dark position-absolute top-50 start-0 translate-middle-y"
                            onclick="navigateImage(-1)" style="z-index: 1000;">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <img id="modalImage" src="" class="img-fluid" alt="Full size image">
                        <button class="btn btn-dark position-absolute top-50 end-0 translate-middle-y"
                            onclick="navigateImage(1)" style="z-index: 1000;">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Edit Image Modal -->
        <div class="modal fade" id="editImageModal" tabindex="-1" aria-labelledby="editImageModalLabel"
            aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editImageModalLabel">Edit Image</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="image-container" style="text-align: center; margin-bottom: 20px;">
                                    <img id="editImage" src="" class="img-fluid" alt="Image to edit"
                                        style="max-height: 400px;">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <h6>Rotation Controls</h6>
                                <div class="d-grid gap-2">
                                    <button class="btn btn-primary" onclick="rotateImage(90)">
                                        <i class="fas fa-redo"></i> Rotate Right (90°)
                                    </button>
                                    <button class="btn btn-primary" onclick="rotateImage(180)">
                                        <i class="fas fa-sync"></i> Rotate 180°
                                    </button>
                                    <button class="btn btn-primary" onclick="rotateImage(270)">
                                        <i class="fas fa-undo"></i> Rotate Left (270°)
                                    </button>
                                    <button class="btn btn-secondary" onclick="resetRotation()">
                                        <i class="fas fa-home"></i> Reset Rotation
                                    </button>
                                </div>
                                <hr>
                                <div class="d-grid gap-2">
                                    <button class="btn btn-success" onclick="saveImageChanges()">
                                        <i class="fas fa-save"></i> Save Changes
                                    </button>
                                    <button class="btn btn-danger" onclick="deleteCurrentImage()">
                                        <i class="fas fa-trash"></i> Delete Image
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row mb-4">
            <!-- Filter Controls -->
            <div class="col-md-4">
                <label for="userFilter" class="form-label">Filter by User ID:</label>
                <select class="form-select" id="userFilter">
                    <option value="">All Users</option>
                    <!-- User IDs will be populated dynamically -->
                </select>
            </div>
            <div class="col-md-3">
                <label for="sortOrder" class="form-label">Sort by:</label>
                <select class="form-select" id="sortOrder">
                    <option value="newest">Newest First</option>
                    <option value="oldest">Oldest First</option>
                    <option value="votes">Most Votes</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Vote Status:</label>
                <div class="alert alert-info mb-0" id="voteStatus">
                    Votes remaining: <span id="votesRemaining">3</span>
                </div>
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <div class="btn-group w-100">
                    <button class="btn btn-primary" id="refreshBtn">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                    <button class="btn btn-info" id="testConnectionBtn">
                        <i class="fas fa-plug"></i>
                    </button>
                    <button class="btn btn-warning" onclick="resetVotes()" title="Reset all votes">
                        <i class="fas fa-undo"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Image Gallery with scrolling -->
        <div class="alert alert-info" id="statusMessage">Loading images...</div>
        <div class="row" id="galleryContainer" style="max-height: calc(100vh - 250px); overflow-y: auto;">
            <!-- Images will be dynamically inserted here -->
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getStorage, ref, listAll, getDownloadURL, deleteObject, uploadBytes } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-storage.js";
        import { getFirestore, collection, getDocs, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        // Your Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyADT4rh94tIthBV32YkFToUaX9preqWwE4",
            authDomain: "link-aka-251025.firebaseapp.com",
            projectId: "link-aka-251025",
            storageBucket: "link-aka-251025.firebasestorage.app",
            messagingSenderId: "431182649515",
            appId: "1:431182649515:web:171eae8973d3c863607fee",
            measurementId: "G-RMDK7NNMBQ"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const storage = getStorage(app);
        const db = getFirestore(app);

        // Display connection status
        const statusMessage = document.getElementById('statusMessage');
        statusMessage.innerHTML = `
            <strong>Firebase Connection:</strong> Initialized<br>
            <small>Storage bucket: ${firebaseConfig.storageBucket}</small>
        `;

        // Reference to the stories folder
        const storiesRef = ref(storage, 'stories');
        const aiGeneratedRef = ref(storage, 'ai_generated');

        let allImages = []; // Store all images data
        let allStories = []; // Store all stories data

        // Function to load all stories from Firestore
        async function loadStories() {
            try {
                const storiesCollection = collection(db, 'stories');
                const storiesSnapshot = await getDocs(storiesCollection);

                allStories = storiesSnapshot.docs.map(doc => {
                    const data = doc.data();
                    return {
                        id: doc.id,
                        userId: data.userId,
                        storyText: data.storyText,
                        storyElements: data.storyElements,
                        style: data.style,
                        length: data.length,
                        timestamp: new Date(data.timestamp),
                        type: 'ai_generated_story',
                        votes: getImageVotes(doc.id) // Reuse voting system for stories
                    };
                });

                console.log(`Loaded ${allStories.length} stories from Firestore`);
            } catch (error) {
                console.error("Error loading stories:", error);
                allStories = [];
            }
        }

        // Function to load all images
        async function loadImages() {
            const statusMessage = document.getElementById('statusMessage');
            statusMessage.className = 'alert alert-info';
            statusMessage.textContent = 'Loading images and stories...';

            try {
                // Load both images and stories
                await Promise.all([
                    loadImagesFromStorage(),
                    loadStories()
                ]);

                if (allImages.length === 0 && allStories.length === 0) {
                    statusMessage.className = 'alert alert-warning';
                    statusMessage.textContent = 'No AI-generated content found.';
                    return;
                }

                statusMessage.className = 'alert alert-success';
                statusMessage.textContent = `Successfully loaded ${allImages.length} images and ${allStories.length} stories.`;

                // Populate user filter dropdown
                populateUserFilter();

                filterAndDisplayImages();
            } catch (error) {
                console.error("Error loading content:", error);
                statusMessage.className = 'alert alert-danger';
                statusMessage.textContent = `Error loading content: ${error.message}`;
            }
        }

        // Function to load images from storage
        async function loadImagesFromStorage() {
            const result = await listAll(aiGeneratedRef);

            if (result.items.length === 0) {
                allImages = [];
                return;
            }

            allImages = await Promise.all(
                result.items.map(async (item) => {
                    try {
                        const url = await getDownloadURL(item);
                        const name = item.name;
                        // Parse filename to get userId, timestamp, type, and prompt
                        const filenameParts = name.split('_');
                        const userId = filenameParts[0];
                        const timestamp = parseInt(filenameParts[1]);
                        const type = filenameParts[2];
                        // Get the complete prompt from the filename and decode it
                        const encodedPrompt = filenameParts.slice(3).join('_').replace('.png', '');
                        const prompt = decodeURIComponent(encodedPrompt).replace(/_/g, ' ');

                        // Get vote count for this image
                        const voteCount = getImageVotes(name);

                        return {
                            url,
                            name,
                            userId,
                            timestamp,
                            type,
                            prompt,
                            date: new Date(timestamp),
                            votes: voteCount
                        };
                    } catch (error) {
                        console.error(`Error getting download URL for ${item.name}:`, error);
                        return null;
                    }
                })
            );

            // Filter out any null values from failed downloads
            allImages = allImages.filter(img => img !== null);
        }

        let currentImageIndex = 0;
        let filteredImages = [];

        // Make navigateImage function available globally
        window.navigateImage = function (direction) {
            currentImageIndex = (currentImageIndex + direction + filteredImages.length) % filteredImages.length;
            const modalImage = document.getElementById('modalImage');
            modalImage.src = filteredImages[currentImageIndex].url;
        }

        window.openImageModal = function (imageUrl) {
            const modalImage = document.getElementById('modalImage');
            modalImage.src = imageUrl;
            // Find the index of the clicked image
            currentImageIndex = filteredImages.findIndex(img => img.url === imageUrl);
            const modal = new bootstrap.Modal(document.getElementById('imageModal'));
            modal.show();
        }

        // Function to filter and display images and stories
        function filterAndDisplayImages() {
            const statusMessage = document.getElementById('statusMessage');
            const gallery = document.getElementById('galleryContainer');
            gallery.innerHTML = '';

            if (allImages.length === 0 && allStories.length === 0) {
                return;
            }

            const userFilter = document.getElementById('userFilter').value;
            const sortOrder = document.getElementById('sortOrder').value;

            // Filter images
            const filteredImages = allImages.filter(img => {
                const matchesUser = !userFilter || img.userId === userFilter;
                return matchesUser;
            });

            // Filter stories
            const filteredStories = allStories.filter(story => {
                const matchesUser = !userFilter || story.userId === userFilter;
                return matchesUser;
            });

            // Combine and sort all content
            let allContent = [...filteredImages, ...filteredStories];

            if (allContent.length === 0) {
                statusMessage.className = 'alert alert-info';
                statusMessage.textContent = 'No content matches your filter criteria.';
                return;
            }

            // Sort content based on the selected sort order
            if (sortOrder === "newest") {
                allContent.sort((a, b) => b.timestamp - a.timestamp);
            } else if (sortOrder === "oldest") {
                allContent.sort((a, b) => a.timestamp - b.timestamp);
            } else if (sortOrder === "votes") {
                allContent.sort((a, b) => (b.votes || 0) - (a.votes || 0));
            }

            statusMessage.className = 'alert alert-success';
            statusMessage.textContent = `Displaying ${allContent.length} items (${filteredImages.length} images, ${filteredStories.length} stories).`;

            allContent.forEach(item => {
                if (item.type === 'ai_generated_story') {
                    displayStoryCard(item);
                } else {
                    displayImageCard(item);
                }
            });
        }

        // Function to display a story card
        function displayStoryCard(story) {
            const gallery = document.getElementById('galleryContainer');
            const col = document.createElement('div');
            col.className = 'col-md-6 mb-4';

            // Check if current user can vote on this story
            const currentUserId = localStorage.getItem('currentUserId');
            const canVote = currentUserId && currentUserId !== story.userId && !hasVotedOnImage(story.id);
            const voteButtonClass = canVote ? 'btn-success' : 'btn-secondary';
            const voteButtonDisabled = !canVote ? 'disabled' : '';
            const voteButtonText = hasVotedOnImage(story.id) ? '<i class="fas fa-check"></i> Voted' : '<i class="fas fa-thumbs-up"></i> Vote';

            // Check if this is the user's own story
            const isOwnStory = currentUserId === story.userId;

            col.innerHTML = `
                <div class="card h-100">
                    <div class="card-header bg-primary text-white">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-book me-2"></i>AI Generated Story
                        </h5>
                    </div>
                    <div class="card-body">
                        <h6 class="card-subtitle mb-2 text-muted">User ID: ${story.userId}</h6>
                        <p class="card-text text-muted">Generated: ${story.timestamp.toLocaleString()}</p>
                        <p class="card-text">
                            <strong>Style:</strong> ${story.style}<br>
                            <strong>Length:</strong> ${story.length}<br>
                            <strong>Story Elements:</strong><br>
                            <small class="text-muted">
                                Who: ${story.storyElements.who}<br>
                                When: ${story.storyElements.when}<br>
                                Where: ${story.storyElements.where}<br>
                                What: ${story.storyElements.what}<br>
                                Why: ${story.storyElements.why}<br>
                                How: ${story.storyElements.how}
                            </small>
                        </p>
                        <div class="story-content" style="max-height: 200px; overflow-y: auto; border: 1px solid #dee2e6; padding: 10px; border-radius: 5px; background-color: #f8f9fa;">
                            <p class="card-text" style="white-space: pre-wrap; font-size: 0.9rem;">${story.storyText}</p>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mt-3">
                            <div class="vote-section">
                                <span class="badge bg-primary me-2">Votes: <span id="votes-${story.id}">${story.votes || 0}</span></span>
                                <button class="btn btn-sm ${voteButtonClass}" ${voteButtonDisabled} 
                                        onclick="voteForImage('${story.id}', '${story.userId}')" 
                                        data-filename="${story.id}">
                                    ${voteButtonText}
                                </button>
                            </div>
                            ${isOwnStory ? `
                                <div class="btn-group">
                                    <button class="btn btn-danger btn-sm delete-story-btn" data-story-id="${story.id}" title="Delete Story">
                                        <i class="fas fa-trash"></i> Delete
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
            gallery.appendChild(col);

            // Add event listener for delete button
            if (isOwnStory) {
                const deleteBtn = col.querySelector('.delete-story-btn');
                deleteBtn.addEventListener('click', function (e) {
                    e.preventDefault();
                    e.stopPropagation();
                    if (confirm('Are you sure you want to delete this story?')) {
                        deleteStory(story.id);
                    }
                });
            }
        }

        // Function to display an image card
        function displayImageCard(img) {
            const gallery = document.getElementById('galleryContainer');
            const col = document.createElement('div');
            col.className = 'col-md-4 mb-4';

            // Check if current user can vote on this image
            const currentUserId = localStorage.getItem('currentUserId');
            const canVote = currentUserId && currentUserId !== img.userId && !hasVotedOnImage(img.name);
            const voteButtonClass = canVote ? 'btn-success' : 'btn-secondary';
            const voteButtonDisabled = !canVote ? 'disabled' : '';
            const voteButtonText = hasVotedOnImage(img.name) ? '<i class="fas fa-check"></i> Voted' : '<i class="fas fa-thumbs-up"></i> Vote';

            // Check if this is the user's own image
            const isOwnImage = currentUserId === img.userId;

            // Check if there's a stored rotation for this image
            const imageRotations = JSON.parse(localStorage.getItem('imageRotations') || '{}');
            const storedRotation = imageRotations[img.name] || 0;
            const rotationStyle = storedRotation !== 0 ? `transform: rotate(${storedRotation}deg);` : '';

            col.innerHTML = `
                    <div class="card">
                        <div class="image-container" style="position: relative; overflow: hidden; min-height: 200px; display: flex; align-items: center; justify-content: center;">
                            <img src="${img.url}" class="card-img-top" alt="AI Generated Image" style="cursor: pointer; ${rotationStyle}; max-width: 100%; max-height: 300px; object-fit: contain;" 
                                 onclick="openImageModal('${img.url}')">
                        </div>
                        <div class="card-body">
                            <h5 class="card-title">User ID: ${img.userId}</h5>
                            <p class="card-text">Generated: ${img.date.toLocaleString()}</p>
                            <p class="card-text">
                                <strong>Type:</strong> ${img.type}<br>
                                <strong>Prompt:</strong><br>
                                <span style="white-space: pre-wrap; word-wrap: break-word;">${img.prompt}</span>
                            </p>
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="vote-section">
                                    <span class="badge bg-primary me-2">Votes: <span id="votes-${img.name}">${img.votes || 0}</span></span>
                                    <button class="btn btn-sm ${voteButtonClass}" ${voteButtonDisabled} 
                                            onclick="voteForImage('${img.name}', '${img.userId}')" 
                                            data-filename="${img.name}">
                                        ${voteButtonText}
                                    </button>
                                </div>
                                ${isOwnImage ? `
                                    <div class="btn-group">
                                        <button class="btn btn-warning btn-sm" onclick="editImage('${img.url}', '${img.name}', '${img.userId}')" title="Edit Image">
                                            <i class="fas fa-edit"></i> Edit
                                        </button>
                                        <button class="btn btn-danger btn-sm delete-btn" data-filename="${img.name}" title="Delete Image">
                                            <i class="fas fa-trash"></i> Delete
                                        </button>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            gallery.appendChild(col);
        }

        // Add event listeners to delete buttons
        document.querySelectorAll('.delete-btn').forEach(button => {
            button.addEventListener('click', function (e) {
                e.preventDefault();
                e.stopPropagation();

                const button = e.target.closest('.delete-btn');
                if (!button) return;

                const filename = button.dataset.filename;
                if (!filename) {
                    console.error('No filename found in data attribute');
                    return;
                }

                if (confirm('Are you sure you want to delete this AI-generated image?')) {
                    deleteImage(filename);
                }
            });
        });

        // Function to populate user ID dropdown
        function populateUserFilter() {
            const userFilter = document.getElementById('userFilter');
            const existingOptions = userFilter.querySelectorAll('option');

            // Keep the "All Users" option
            userFilter.innerHTML = '<option value="">All Users</option>';

            // Get unique user IDs from both images and stories
            const imageUserIds = allImages.map(img => img.userId);
            const storyUserIds = allStories.map(story => story.userId);
            const uniqueUserIds = [...new Set([...imageUserIds, ...storyUserIds])].sort((a, b) => parseInt(a) - parseInt(b));

            // Add user ID options
            uniqueUserIds.forEach(userId => {
                const option = document.createElement('option');
                option.value = userId;
                option.textContent = `User ${userId}`;
                userFilter.appendChild(option);
            });
        }

        // Function to delete a story
        async function deleteStory(storyId) {
            const currentUserId = localStorage.getItem('currentUserId');

            // Find the story to check ownership
            const storyToDelete = allStories.find(story => story.id === storyId);
            if (!storyToDelete) {
                alert('Story not found!');
                return;
            }

            // Check if user is trying to delete their own story
            if (currentUserId !== storyToDelete.userId) {
                alert('You can only delete your own stories!');
                return;
            }

            const statusMessage = document.getElementById('statusMessage');
            statusMessage.className = 'alert alert-info';
            statusMessage.textContent = 'Deleting story...';

            try {
                await deleteDoc(doc(db, 'stories', storyId));
                statusMessage.className = 'alert alert-success';
                statusMessage.textContent = 'Story deleted successfully!';
                loadImages(); // Reload all content
            } catch (error) {
                console.error("Error deleting story:", error);
                statusMessage.className = 'alert alert-danger';
                statusMessage.textContent = `Failed to delete story: ${error.message}`;
            }
        }

        // Function to delete an image
        async function deleteImage(filename) {
            const currentUserId = localStorage.getItem('currentUserId');

            // Find the image to check ownership
            const imageToDelete = allImages.find(img => img.name === filename);
            if (!imageToDelete) {
                alert('Image not found!');
                return;
            }

            // Check if user is trying to delete their own image
            if (currentUserId !== imageToDelete.userId) {
                alert('You can only delete your own images!');
                return;
            }

            const statusMessage = document.getElementById('statusMessage');
            statusMessage.className = 'alert alert-info';
            statusMessage.textContent = 'Deleting image...';

            try {
                const imageRef = ref(storage, `ai_generated/${filename}`);
                await deleteObject(imageRef);
                statusMessage.className = 'alert alert-success';
                statusMessage.textContent = 'Image deleted successfully!';
                loadImages();
            } catch (error) {
                console.error("Error deleting image:", error);
                statusMessage.className = 'alert alert-danger';
                statusMessage.textContent = `Failed to delete image: ${error.message}`;
            }
        }

        // Add event listeners for filters and refresh button
        document.getElementById('userFilter').addEventListener('input', filterAndDisplayImages);
        document.getElementById('sortOrder').addEventListener('change', filterAndDisplayImages);
        document.getElementById('refreshBtn').addEventListener('click', loadImages);

        // Add event listener for test connection button
        document.getElementById('testConnectionBtn').addEventListener('click', testFirebaseConnection);

        // Function to test Firebase connectivity
        async function testFirebaseConnection() {
            const statusMessage = document.getElementById('statusMessage');
            statusMessage.className = 'alert alert-info';
            statusMessage.textContent = 'Testing Firebase connection...';

            try {
                // Try to create a test reference
                const testRef = ref(storage, `.connection_test_${Date.now()}`);

                // Try to upload a small test file
                const testBlob = new Blob(['connection_test'], { type: 'text/plain' });
                await uploadBytes(testRef, testBlob);

                // Try to get the download URL
                const downloadURL = await getDownloadURL(testRef);

                // If we get here, the connection is working
                statusMessage.className = 'alert alert-success';
                statusMessage.innerHTML = `
                    <strong>Firebase connection successful!</strong><br>
                    Storage bucket: ${firebaseConfig.storageBucket}<br>
                    Test file uploaded to: ${downloadURL}
                `;
                console.log('Firebase connection test successful:', downloadURL);

                // Try loading images again
                loadImages();

                return true;
            } catch (error) {
                statusMessage.className = 'alert alert-danger';
                statusMessage.innerHTML = `
                    <strong>Firebase connection failed!</strong><br>
                    Error: ${error.message}<br>
                    Please check your Firebase configuration and internet connection.
                `;
                console.error('Firebase connection test failed:', error);
                return false;
            }
        }

        // Load images when page loads
        loadImages();

        // Voting system functions
        let userVotes = JSON.parse(localStorage.getItem('userVotes') || '[]');
        let totalVotesUsed = userVotes.length;

        // Function to get user-specific votes
        function getUserVotes() {
            const currentUserId = localStorage.getItem('currentUserId');
            if (!currentUserId) return [];

            const allUserVotes = JSON.parse(localStorage.getItem('userVotes') || '{}');
            return allUserVotes[currentUserId] || [];
        }

        // Function to save user-specific votes
        function saveUserVotes(votes) {
            const currentUserId = localStorage.getItem('currentUserId');
            if (!currentUserId) return;

            const allUserVotes = JSON.parse(localStorage.getItem('userVotes') || '{}');
            allUserVotes[currentUserId] = votes;
            localStorage.setItem('userVotes', JSON.stringify(allUserVotes));
        }

        // Function to check if user has voted on a specific image
        function hasVotedOnImage(imageName) {
            const userVotes = getUserVotes();
            return userVotes.includes(imageName);
        }

        // Function to get votes for an image from localStorage
        function getImageVotes(imageName) {
            const imageVotes = JSON.parse(localStorage.getItem('imageVotes') || '{}');
            return imageVotes[imageName] || 0;
        }

        // Function to update image votes in localStorage
        function updateImageVotes(imageName, newVoteCount) {
            const imageVotes = JSON.parse(localStorage.getItem('imageVotes') || '{}');
            imageVotes[imageName] = newVoteCount;
            localStorage.setItem('imageVotes', JSON.stringify(imageVotes));
        }

        // Function to vote for an image
        window.voteForImage = function (imageName, imageUserId) {
            const currentUserId = localStorage.getItem('currentUserId');

            if (!currentUserId) {
                alert('Please log in to vote!');
                return;
            }

            // Check if user is trying to vote on their own image
            if (currentUserId === imageUserId) {
                alert('You cannot vote on your own image!');
                return;
            }

            // Get current user's votes
            const userVotes = getUserVotes();
            const totalVotesUsed = userVotes.length;

            // Check if user has already voted on this image
            if (hasVotedOnImage(imageName)) {
                alert('You have already voted on this image!');
                return;
            }

            // Check if user has used all their votes
            if (totalVotesUsed >= 3) {
                alert('You have used all your votes!');
                return;
            }

            // Add vote to user's voting history
            userVotes.push(imageName);
            saveUserVotes(userVotes);

            // Get current vote count for this image and increment it
            const currentVotes = getImageVotes(imageName);
            const newVoteCount = currentVotes + 1;
            updateImageVotes(imageName, newVoteCount);

            // Update the image object in allImages array
            const imageIndex = allImages.findIndex(img => img.name === imageName);
            if (imageIndex !== -1) {
                allImages[imageIndex].votes = newVoteCount;
            }

            // Update display
            updateVoteDisplay();
            updateVoteButton(imageName, false);

            // Update vote count display immediately
            const voteCountElement = document.getElementById(`votes-${imageName}`);
            if (voteCountElement) {
                voteCountElement.textContent = newVoteCount;
            }

            // Update the vote button to show it's been voted on
            const voteButton = document.querySelector(`button[data-filename="${imageName}"]`);
            if (voteButton) {
                voteButton.className = 'btn btn-sm btn-secondary';
                voteButton.disabled = true;
                voteButton.innerHTML = '<i class="fas fa-check"></i> Voted';
            }

            alert(`Vote recorded successfully! This image now has ${newVoteCount} vote(s).`);
        }

        // Function to update vote display
        function updateVoteDisplay() {
            const currentUserId = localStorage.getItem('currentUserId');
            if (!currentUserId) {
                const votesRemainingElement = document.getElementById('votesRemaining');
                if (votesRemainingElement) {
                    votesRemainingElement.textContent = '0';
                }
                return;
            }

            const userVotes = getUserVotes();
            const votesRemaining = 3 - userVotes.length;

            const votesRemainingElement = document.getElementById('votesRemaining');
            if (votesRemainingElement) {
                votesRemainingElement.textContent = votesRemaining;
            }

            // Update vote status color
            const voteStatus = document.getElementById('voteStatus');
            if (votesRemaining === 0) {
                voteStatus.className = 'alert alert-warning mb-0';
            } else if (votesRemaining <= 1) {
                voteStatus.className = 'alert alert-info mb-0';
            } else {
                voteStatus.className = 'alert alert-success mb-0';
            }
        }

        // Function to update vote button state
        function updateVoteButton(imageName, canVote) {
            const voteButton = document.querySelector(`button[data-filename="${imageName}"]`);
            if (voteButton) {
                if (canVote) {
                    voteButton.className = 'btn btn-sm btn-success';
                    voteButton.disabled = false;
                } else {
                    voteButton.className = 'btn btn-sm btn-secondary';
                    voteButton.disabled = true;
                }
            }
        }

        // Function to reset votes (for testing purposes)
        window.resetVotes = function () {
            const currentUserId = localStorage.getItem('currentUserId');
            if (!currentUserId) {
                alert('Please log in to reset votes!');
                return;
            }

            if (confirm('Are you sure you want to reset your votes? This will clear your voting history.')) {
                // Reset only current user's votes
                const allUserVotes = JSON.parse(localStorage.getItem('userVotes') || '{}');
                delete allUserVotes[currentUserId];
                localStorage.setItem('userVotes', JSON.stringify(allUserVotes));

                // Reset image vote counts
                localStorage.setItem('imageVotes', JSON.stringify({}));

                updateVoteDisplay();
                filterAndDisplayImages(); // Refresh the display
                alert('Your votes have been reset!');
            }
        }

        // Image editing variables
        let currentEditImage = null;
        let currentRotation = 0;

        // Function to open edit modal
        window.editImage = function (imageUrl, imageName, imageUserId) {
            const currentUserId = localStorage.getItem('currentUserId');

            // Check if user is trying to edit their own image
            if (currentUserId !== imageUserId) {
                alert('You can only edit your own images!');
                return;
            }

            currentEditImage = { url: imageUrl, name: imageName, userId: imageUserId };
            currentRotation = 0;

            // Set the image in the edit modal
            const editImageElement = document.getElementById('editImage');
            editImageElement.src = imageUrl;
            editImageElement.style.transform = 'rotate(0deg)';

            // Open the edit modal
            const editModal = new bootstrap.Modal(document.getElementById('editImageModal'));
            editModal.show();
        }

        // Function to rotate image
        window.rotateImage = function (degrees) {
            const editImageElement = document.getElementById('editImage');
            currentRotation = (currentRotation + degrees) % 360;
            editImageElement.style.transform = `rotate(${currentRotation}deg)`;
        }

        // Function to reset rotation
        window.resetRotation = function () {
            const editImageElement = document.getElementById('editImage');
            currentRotation = 0;
            editImageElement.style.transform = 'rotate(0deg)';
        }

        // Function to save image changes
        window.saveImageChanges = async function () {
            if (!currentEditImage) {
                alert('No image selected for editing!');
                return;
            }

            if (currentRotation === 0) {
                alert('No changes to save!');
                return;
            }

            // Show loading state
            const saveButton = document.querySelector('#editImageModal .btn-success');
            const originalText = saveButton.innerHTML;
            saveButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
            saveButton.disabled = true;

            try {
                // Try the primary approach first
                await saveImageWithCanvas();
            } catch (error) {
                console.error('Primary approach failed:', error);

                // Fallback: Use a simpler approach that just updates the display
                try {
                    await saveImageFallback();
                } catch (fallbackError) {
                    console.error('Fallback approach also failed:', fallbackError);
                    throw fallbackError;
                } finally {
                    // Restore button state
                    saveButton.innerHTML = originalText;
                    saveButton.disabled = false;
                }
            }
        }

        // Primary approach using canvas
        async function saveImageWithCanvas() {
            // Create a canvas to apply rotation
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');

            // Create a new image element
            const img = new Image();

            // Set up image loading with proper error handling
            const imageLoadPromise = new Promise((resolve, reject) => {
                img.onload = () => resolve(img);
                img.onerror = () => reject(new Error('Failed to load image'));

                // Try to load the image with CORS handling
                img.crossOrigin = 'anonymous';
                img.src = currentEditImage.url;

                // Fallback: if image is already loaded
                if (img.complete) {
                    resolve(img);
                }
            });

            // Wait for image to load
            const loadedImg = await imageLoadPromise;

            // Calculate new dimensions based on rotation
            let newWidth, newHeight;
            if (currentRotation === 90 || currentRotation === 270) {
                newWidth = loadedImg.height;
                newHeight = loadedImg.width;
            } else {
                newWidth = loadedImg.width;
                newHeight = loadedImg.height;
            }

            // Set canvas size
            canvas.width = newWidth;
            canvas.height = newHeight;

            // Clear canvas and set background
            ctx.fillStyle = '#FFFFFF';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Move to center and rotate
            ctx.translate(canvas.width / 2, canvas.height / 2);
            ctx.rotate((currentRotation * Math.PI) / 180);
            ctx.drawImage(loadedImg, -loadedImg.width / 2, -loadedImg.height / 2);

            // Convert canvas to blob with error handling
            const blobPromise = new Promise((resolve, reject) => {
                try {
                    canvas.toBlob((blob) => {
                        if (blob) {
                            resolve(blob);
                        } else {
                            reject(new Error('Failed to create image blob'));
                        }
                    }, 'image/png', 0.9);
                } catch (error) {
                    reject(error);
                }
            });

            const rotatedBlob = await blobPromise;

            // Upload rotated image to Firebase
            const rotatedImageRef = ref(storage, `ai_generated/${currentEditImage.name}`);
            await uploadBytes(rotatedImageRef, rotatedBlob);

            // Get the new download URL
            const newUrl = await getDownloadURL(rotatedImageRef);

            // Update the image object in allImages array
            const imageIndex = allImages.findIndex(img => img.name === currentEditImage.name);
            if (imageIndex !== -1) {
                allImages[imageIndex].url = newUrl;
            }

            // Update the current edit image URL
            currentEditImage.url = newUrl;

            // Update the edit modal image
            const editImageElement = document.getElementById('editImage');
            editImageElement.src = newUrl;
            editImageElement.style.transform = 'rotate(0deg)';

            // Refresh the display
            filterAndDisplayImages();

            alert('Image rotation saved successfully!');

            // Close the edit modal
            const editModal = bootstrap.Modal.getInstance(document.getElementById('editImageModal'));
            editModal.hide();
        }

        // Fallback approach - just update the display with rotation info
        async function saveImageFallback() {
            // Store rotation information in localStorage for this image
            const imageRotations = JSON.parse(localStorage.getItem('imageRotations') || '{}');
            imageRotations[currentEditImage.name] = currentRotation;
            localStorage.setItem('imageRotations', JSON.stringify(imageRotations));

            // Update the display to show the rotation
            const editImageElement = document.getElementById('editImage');
            editImageElement.style.transform = 'rotate(0deg)';

            // Refresh the display
            filterAndDisplayImages();

            alert('Image rotation applied to display. Note: This is a temporary rotation that will be visible during this session.');

            // Close the edit modal
            const editModal = bootstrap.Modal.getInstance(document.getElementById('editImageModal'));
            editModal.hide();
        }

        // Function to delete current image from edit modal
        window.deleteCurrentImage = function () {
            if (!currentEditImage) {
                alert('No image selected for deletion!');
                return;
            }

            if (confirm('Are you sure you want to delete this image?')) {
                deleteImage(currentEditImage.name);

                // Close the edit modal
                const editModal = bootstrap.Modal.getInstance(document.getElementById('editImageModal'));
                editModal.hide();
            }
        }
    </script>

    <script src="script.js"></script>
    <script>
        // Update user ID display in the navbar
        const userIdDisplay = document.getElementById('userIdDisplay');
        const currentUserId = localStorage.getItem('currentUserId');

        if (userIdDisplay && currentUserId) {
            userIdDisplay.textContent = `User ID: ${currentUserId} ${getEmojiForUserId(currentUserId)}`;
            userIdDisplay.classList.remove('d-none');
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>